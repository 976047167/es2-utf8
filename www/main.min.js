function setChatChannel(e,t){switch(e){case"say":case"chat":case"whisper":case"rumor":case"wiz":case"sys":break;default:e="",t=""}_chatChannel=e,$("a#chatchannel").text("频道:"+t)}function getChatChannel(){return _chatChannel}function parseSmiley(e){var t=e.match(/：\/[0-9]+\//gi);if(t){t=_.unique(t);for(var a=0;a<t.length;a++){var r=t[a],n=parseInt(r.replace("：/",""),10),i='<div class="triangle"></div><img class="sm" src="sm/'+n+'.png"/>';e=e.replace(new RegExp("：\\/"+n+"\\/","gi"),"："+i)}}return e}function sendChat(e){var t=_chatChannel||"say";"whisper"==t&&(t+=" "+getTargetChar()),e=t+" "+e,sendCmd&&e&&sendCmd(e)}function onChannel(e){var t=$(e.currentTarget),a=t.attr("c"),r=t.text();setChatChannel(a,r)}function onSmiley(e){var t=$(e.currentTarget),a=_chatChannel||"say";"whisper"==a&&(a+=" "+getTargetChar());var r=a+" "+t.attr("macro");sendCmd&&r&&sendCmd(r)}function initSmileys(e){for(var t=0;124>=t;t++){var a="sm/"+t+".png",r="/"+t+"/";$("<img>").attr("src",a).attr("macro",r).addClass("smiley").click(onSmiley).appendTo(e)}}function initModChat(e){$("button.channel").click(onChannel),initKeys(CHAT_CMDS,"div#chatkeys",e),initSmileys("div#chatkeys")}function getAllDirs(){return ALL_DIRS}function parseExits(e){for(var t=e.split(ROOM_MARK),a=1;a<t.length;a++){var r=t[a],n=r.split("\n")[0],i=r.indexOf(EXITS_MARK);if(!(0>i&&(i=r.indexOf(EXITS_MASK2),0>i))){i+=EXITS_MARK.length;var o=r.indexOf("。",i);if(!(0>o)){for(var s=r.substr(i,o-i).replace(ESC_1,"").replace(ESC_2,"").replace(/、/g,",").replace("和",",").split(","),c=0;c<s.length;c++)s[c]=s[c].trim();mapCheckRoom(n,s);for(var l={},c=0;c<SHORT_DIRS.length;c++)l[SHORT_DIRS[c]]=0;for(var d=$("table#go"),c=0;c<s.length;c++){var m=s[c],u=ALL_DIRS[m];if(u){var p=u[0],g=u[1];$("button#"+p,d).attr("macro",m).text(g).removeClass("disable"),l[p]=1}}for(var h in l){var f=$("button#"+h,d);l[h]||f.attr("macro","").text("").addClass("disable")}}}}}function parseRoom(e){return setCmdTarget(""),setCmdItem(""),$("div#out").find("a").contents().unwrap(),parseExits(e),addTargetLinks(e,"look")}function parseChar(e){setCmdItem("");for(var t=e.split(CHAR_MARK),a=1;a<t.length;a++){var r=t[a],n=r.match(/\([\w ]+\)/gi);if(n){var i=n[0].replace("(","").replace(")",""),o=i.toLowerCase();setCmdTarget(o);break}}return addTargetLinks(e,"item")}function initModExplore(e){$("button.go").click(e),$("button#od").attr("macro","open door\nlook"),initKeys(EXPLORE_CMDS,"div#expkeys",e),initKeys(MARTIAL_CMDS,"div#markeys",e),initKeys(OTHER_CMDS,"div#otherkeys",e)}function getDirXY(){return DIR_XY}function mapCheckCmd(e){for(var t=e.split("\n"),a=getAllDirs(),r=0;r<t.length;r++){var n=_.compact(t[r].trim().split(" ")),i=n[0];if(!i)return;if(n.length>1)switch(i){case"go":a[n[1]]&&(i=n[1]);break;case"l":case"look":a[n[1]]&&(i="l "+n[1])}if("l"===i||"look"===i)steps.push("l");else for(var o in DIR_XY){var s=DIR_XY[o];if(i===o||i===s[0]){steps.push(o);break}}}}function mapOnGoFail(){steps.shift()}function mapOnFlee(e){}function mapCheckRoom(e,t){var a=getAllDirs(),r=!1,n=e.split(" - ");if(2==n.length){var i=n[0],o=n[1];rooms[o]||(rooms[o]={},r=!0);var s=rooms[o];s||console.log(_.keys(rooms)),s.name||(s.name=i),s.x||(s.x=0),s.y||(s.y=0);for(var c=0;c<t.length;c++){var l=t[c];l&&(l=a[l]),l&&(l=l[0]),l&&!s[l]&&(s[l]=1,r=!0)}var d=steps.length>0?steps.shift():"l";if(!(d.indexOf(" ")>=0)){if(s.x&&s.x);else if("l"!==d){var m=DIR_XY[d];if(m&&curAddr){var u=rooms[curAddr];u&&(u[d]=o,s.x=u.x+m[1],s.y=u.y+m[2])}}curAddr=o,drawMap(),r&&saveMap()}}}function saveMap(){localStorage.setItem("rooms",JSON.stringify(rooms))}function loadMap(){var e=localStorage.getItem("rooms");rooms=e&&0===e.indexOf("{")?JSON.parse(e):{}}function setMapViewSize(e,t){var a=$("canvas#map")[0];VIEW_W=a.width=e,VIEW_H=a.height=t,drawMap()}function drawMap(){var e=$("canvas#map")[0],t=e.getContext("2d");t.fillStyle=MAP_BG,t.fillRect(0,0,VIEW_W,VIEW_H);var a=VIEW_W/2,r=VIEW_H/2,n=rooms[curAddr];if(n){t.strokeStyle=MAP_COLOR,t.lineWidth=2;for(var i in rooms){var o=rooms[i],s=a+(o.x-n.x)*ROOM_RANGE,c=r-(o.y-n.y)*ROOM_RANGE;if(!(0>s||s>VIEW_W||0>c||c>VIEW_H)){t.beginPath();for(var l in DIR_XY)if(o[l]){var d=DIR_XY[l];(d[1]||d[2])&&(t.moveTo(s,c),t.lineTo(s+d[1]*ROOM_RANGE,c-d[2]*ROOM_RANGE))}t.stroke()}}t.fillStyle=MAP_COLOR;for(var i in rooms){var o=rooms[i],s=a+(o.x-n.x)*ROOM_RANGE,c=r-(o.y-n.y)*ROOM_RANGE;0>s||s>VIEW_W||0>c||c>VIEW_H||(t.fillRect(s-ROOM_SIZE/2,c-ROOM_SIZE/2,ROOM_SIZE,ROOM_SIZE),t.save(),t.fillStyle=MAP_BG,t.fillRect(s-(ROOM_SIZE/2-2),c-(ROOM_SIZE/2-2),ROOM_SIZE-4,ROOM_SIZE-4),t.restore())}t.fillStyle=ME_COLOR,t.fillRect(a-ME_SIZE/2,r-ME_SIZE/2,ME_SIZE,ME_SIZE),t.textBaseline="top",t.font="normal lighter 16px SimSun",t.lineWidth=.5,t.strokeStyle=MAP_COLOR,t.strokeText(n.name,5,5)}}function initModMap(e){loadMap(),drawMap()}function setCmdItem(e){if(_cmdItem&&e){var t=parseInt(_cmdItem,10)||0,a="";if(t>1){var r=_cmdItem.split(" ");r.shift(),a=r.join(" ")}else a=_cmdItem;a===e?(t=t?t+1:2,_cmdItem=t+" "+e):_cmdItem=e}else _cmdItem=e;$("a#cmditem").text("物品/技能:"+_cmdItem)}function getCmdItem(){return _cmdItem}function setCmdTarget(e){_cmdTarget=e,$("a#cmdtarget").text("目标:"+e)}function getCmdTarget(){return _cmdTarget}function onMacroKey(e){var t=$(e.currentTarget),a=t.attr("macro");sendCmd&&a&&sendCmd(a)}function onTargetLink(e){var t=$(e.currentTarget),a=t.attr("ob");if(a){var r=t.attr("type");switch(r){case"look":sendCmd&&a&&sendCmd("l "+a);break;case"item":case"skill":setCmdItem(a)}}}function scrollDown(){var e=$("div#out");e.scrollTop(e.prop("scrollHeight"))}function writeToScreen(e){var t=$("<p>").append(e).addClass("out");t.appendTo("div#out"),$("a.target",t).on("click",onTargetLink),scrollDown()}function addTargetLinks(e,t){t||(t="look");var a=e.match(/\([\w \-]+\)/gi);if(a){a=_.unique(a);for(var r=0;r<a.length;r++){var n=a[r],i=n.replace("(","").replace(")",""),o=i.toLowerCase(),s='(<a class="target" href="#" type="'+t+'" ob="'+o+'">'+i+"</a>)";e=e.replace(new RegExp("\\("+i+"\\)","gi"),s)}}return e}function writeServerData(e){var t=new Uint8Array(e),a=binayUtf8ToString(t,0);a.indexOf(TELNET_MARK)>=0&&(a=a.replace(TELNET_MARK,"")),a.indexOf(GO_FAIL)>=0&&mapOnGoFail(),askingLogin=askingPass=!1,a.indexOf(ROOM_MARK)>=0?a=parseRoom(a):a.indexOf(CHAR_MARK)>=0?a=parseChar(a):a.indexOf(ITEM_MARK)>=0?a=addTargetLinks(a,"item"):a.indexOf(INV_MARK)>=0?a=addTargetLinks(a,"look"):a.indexOf(SKILLS_MARK)>=0?a=addTargetLinks(a,"skill"):a.indexOf(SMILEY_MARK)>=0?a=parseSmiley(a):a.indexOf(LOGIN_MARK)>=0?askingLogin=!0:a.indexOf(PASS_MARK)>=0&&(askingPass=!0);for(var r=a.split("\r\n"),n=0;n<r.length;n++){var i=r[n].replace(/\s\s/g,"&nbsp;");n<r.length-1&&(i+="<br/>");var o=i.length;o>=2&&"> "==i.substr(o-2)&&(i=i.substr(0,i-2)),i=ansi_up.ansi_to_html(i),writeToScreen(i)}if(askingLogin&&setTimeout(function(){if(autologin=localStorage.getItem("autologin"),autologin&&(autologin=confirm("是否用记住的密码自动登录？")),autologin){var e=localStorage.getItem("username");sendCmd&&e&&sendCmd(e)}},100),askingPass&&autologin){var s=localStorage.getItem("password");sendCmd&&s&&sendCmd(s),$("button#explore").click()}}function connectServer(){var e=io.connect();e.on("data",function(e){writeServerData(e)}),e.on("status",function(e){writeToScreen(e)}),e.on("connected",function(){console.log("connected")}),e.on("disconnect",function(){console.log("disconnected")}),window.sendCmd=function(t){t.indexOf("$target")&&(t=t.replace("$target",getCmdTarget())),t.indexOf("$item")&&(t=t.replace("$item",getCmdItem())),t=t.trim();for(var a=t.split("\n"),r=0;r<a.length;r++){var n=a[r].trim();if(n.indexOf("l ")>=0||n.indexOf("look ")>=0){var i=n.split(" ");i.shift(),setCmdItem(i.join(" "))}mapCheckCmd(n)}e&&e.emit("data",t+"\n")}}function initKeys(e,t,a){for(var r=0;r<e.length;r++){var n=e[r],i="exp"+r,o=n[0],s=n[1],c=n[2];$("<button>").text(o).attr("id",i).attr("macro",s).addClass("keys").addClass(c).click(a).appendTo(t)}}function adjustLayout(){for(var e=$(window).width(),t=$(window).height(),a=$("div#in").width(),r=a,n=["explore","martial","map","chat","others"],i=0;i<n.length;i++)r-=$("button#"+n[i]).outerWidth(!0)+4;$("input#str").css({width:r+"px"});var o=$("table#go"),s=a-o.outerWidth(!0)-12,c=o.outerHeight(!0);$("div#map, div#expkeys").css({width:s+"px",height:c+"px"}),setMapViewSize(s-5,c-5);var l=$("div#in").outerHeight(!0);$("div#out").css({width:e-22+"px",height:t-l-32+"px"}),scrollDown()}function showPad(e){$("div.pad").hide(),e&&$("div#"+e).show(),adjustLayout()}function sendInput(){var e=$("input#str"),t=e.val().trim();if(askingLogin?localStorage.setItem("username",t):askingPass&&(localStorage.setItem("password",t),localStorage.setItem("autologin",confirm("是否记住密码？"))),cmdHistory.length>20&&cmdHistory.unshift(),t&&t!=cmdHistory[cmdHistory.length-1]&&cmdHistory.push(t),cmdIndex=cmdHistory.length,sendCmd){var a=getChatChannel();!a||askingLogin||askingPass?sendCmd(t):sendChat(t)}e.val("")}function cmdHistoryUp(){if(cmdIndex>0){if(cmdIndex--,cmdIndex<cmdHistory.length){var e=cmdHistory[cmdIndex];$("input#str").val(e)}}else $("input#str").val("")}function cmdHistoryDown(){if(cmdIndex<cmdHistory.length-1){cmdIndex++;var e=cmdHistory[cmdIndex];$("input#str").val(e)}else $("input#str").val("")}function initUI(){$(window).resize(adjustLayout),$("button.menu").click(function(e){var t=$(e.currentTarget),a=t.attr("id"),r=t.attr("pad");showPad(r);var n=$("div#map"),i=$("div#expkeys");switch(a){case"explore":n.hide(),i.show();break;case"map":n.is(":visible")?(n.hide(),i.show()):(n.show(),i.hide())}}),$("a#cmdtarget").click(function(e){setCmdTarget("")}),$("a#cmditem").click(function(e){setCmdItem("")}),$("a#chatchannel").click(function(e){setChatChannel("")}),initModExplore(onMacroKey),initModChat(onMacroKey),initModMap(onMacroKey),$("input#str").keydown(function(e){switch(e.keyCode){case 38:cmdHistoryUp();break;case 40:cmdHistoryDown();break;case 13:sendInput()}}),$("input#str").focus(function(e){showPad(null)})}var CHAT_CMDS=[["Hi","say Hi~","emote"],["大笑","emote 大笑起来，笑得眼泪都要出来了。","emote"],["哭","emote 一屁股坐在地上，嚎啕大哭起来。","emote"],["痛苦","emote 哎哟一声，一脸痛苦的样子。","emote"],["邪恶","emote 眨了眨眼，邪恶的笑了。","emote"],["欢迎","chat 欢迎欢迎，热烈欢迎！","chat"],["再见","chat bye~","chat"],["下了","chat 我先下线了哦，bye~","chat"]],_chatChannel="",ROOM_MARK="▲ ",CHAR_MARK="▼ ",ITEM_MARK="◆ ",EXITS_MARK="这里明显的出口是",EXITS_MASK2="这里唯一的出口是",ESC_CHAR=String.fromCharCode(27),ESC_1=new RegExp(ESC_CHAR+"\\[1m","g"),ESC_2=new RegExp(ESC_CHAR+"\\[2;37;0m","g"),ALL_DIRS={north:["n","北"],south:["s","南"],east:["e","东"],west:["w","西"],northup:["n","北上"],southup:["s","南上"],eastup:["e","东上"],westup:["w","西上"],northdown:["n","北下"],southdown:["s","南下"],eastdown:["e","东下"],westdown:["w","西下"],northeast:["ne","东北"],northwest:["nw","西北"],southeast:["se","东南"],southwest:["sw","西南"],up:["up","上"],down:["d","下"],out:["up","外"],enter:["d","里"]},SHORT_DIRS=["n","s","e","w","nw","sw","ne","se","up","d"],EXPLORE_CMDS=[["捡","get $item","explore"],["放","put","explore"],["给","give $item to $target","explore"],["丢","drop $item","explore"],["买","buy $item from $target","explore"],["兑换","convert $item","explore"],["吃","eat $item","explore"],["喝","drink $item","explore"],["穿","wear $item","fight"],["脱","remove $item","fight"],["装备","wield $item","fight"],["放下","unwield $item","fight"],["跟随","follow $target","explore"],["组队","team with $target","explore"],["学习","learn $item from $target","explore"],["切磋","fight $target","fight"],["投降","surrender","fight"],["偷","steal $item from $target","warn"],["物品","i","status"],["状态","hp $target","status"],["技能","skills $target","status"],["成就","score $target","status"],["保存","save","status"],["杀","kill $target","warn"]],MARTIAL_CMDS=[["全技","enable ?","learn"],["拜师","apprentice $target","learn"],["收徒","recruit $target","learn"],["开除","expell $target","learn"],["学习","learn $item from $target","learn"],["弃技","abandon $item","learn"],["练习","practice $item","practice"],["研读","study $item","practice"],["打坐","respirate 30","practice"],["练气","exercise 30","practice"],["冥想","meditate 30","practice"],["放弃","abandon $item","warn"],["用技","enable %skilltype $item","prepare"],["施法","enchant 30","prepare"],["发力","enforce 30","prepare"],["画符","scribe $item on $target","prepare"],["切磋","fight $char","warn"],["投降","surrender","warn"],["传功","exert transfer","exert"],["疗伤","exert heal","exert"],["冲穴","exert mobilize","exert"],["逼毒","exert depoison","exert"],["杀","kill $target","warn"],["逃","wimpy 20","warn"]],OTHER_CMDS=[["物品","i","status"],["头衔","title","status"],["帮助","help","status"],["巫师","wizlist","status"],["绰号","nick","warn"],["密码","passwd","warn"],["保存","save","warn"],["退出","quit","warn"],["兑换","convert $item","explore"],["询价","list","explore"],["推","push","explore"],["拉","pull","explore"],["灌水","fillwater","explore"],["典当","pawn $item","explore"],["赎回","retrieve","explore"],["卖","sell $item","explore"],["工作","work","explore"]],rooms={},steps=[],curAddr="",DIR_XY={n:["north",0,1],s:["south",0,-1],e:["east",1,0],w:["west",-1,0],nu:["northup",0,1],su:["southup",0,-1],eu:["eastup",1,0],wu:["westup",-1,0],nd:["northdown",0,1],sd:["southdown",0,-1],ed:["eastdown",1,0],wd:["westdown",-1,0],ne:["northeast",1,1],nw:["northwest",-1,1],se:["southeast",1,-1],sw:["southwest",-1,-1],u:["up",0,0],d:["down",0,0],out:["out",0,0],enter:["enter",0,0]},VIEW_W=240,VIEW_H=190,MAP_W=640,MAP_H=480,ROOM_RANGE=20,ROOM_SIZE=12,ME_SIZE=8,MAP_BG="#753",MAP_COLOR="#fff",ME_COLOR="#f00",_cmdItem="",_cmdTarget="",ROOM_MARK="▲ ",CHAR_MARK="▼ ",ITEM_MARK="◆ ",TELNET_MARK="ﺢ탿퟿떿놿ﻉ",INV_MARK="带著下列这些东西",SKILLS_MARK="目前所学过的技能",LOGIN_MARK="您的英文名字：",PASS_MARK="请输入密码：",SMILEY_MARK="：/",GO_FAIL="△ ",askingLogin=!1,askingPass=!1,autologin=!1,cmdHistory=[],cmdIndex=0;$(document).ready(function(){initUI(),setTimeout(function(){adjustLayout(),setTimeout(function(){connectServer()},200)},100)});